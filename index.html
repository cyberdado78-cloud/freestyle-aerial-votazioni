<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Votazioni Live ‚Äì Freestyle Aerial Competition</title>

  <!-- Firebase COMPAT (stabile su mobile) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <style>
    /* ======================
       BRAND COLORS (BIANCO/ROSSO/ORO/NERO)
    ======================= */
    :root{
      --bg: #f5f5f7;
      --bg-dark: #050505;
      --card: #ffffff;
      --card-dark: #101010;
      --text: #111111;
      --muted: #666666;
      --brand-red: #c1121f;
      --brand-gold: #d4af37;
      --brand-black: #141414;
      --brand-white: #ffffff;
      --line: rgba(0,0,0,0.08);
      --accent: #c1121f;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      padding:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #ffffff 0, #f5f5f7 45%, #e5e5ea 100%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    .appWrap{
      max-width:1120px;
      margin:0 auto;
      padding:16px;
    }

    h1,h2,h3{
      margin:0 0 8px;
      font-weight:700;
      letter-spacing:0.03em;
      text-transform:uppercase;
    }

    p{ margin:4px 0; }

    /* LAYOUT */
    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .col{
      flex:1 1 0;
      min-width:200px;
    }

    /* CARD */
    .card{
      background:var(--card);
      border-radius:16px;
      padding:16px;
      box-shadow:
        0 14px 38px rgba(0,0,0,0.08),
        0 3px 8px rgba(0,0,0,0.08);
      border:1px solid rgba(255,255,255,0.9);
    }

    .card.center{
      text-align:center;
    }

    /* TOPBAR */
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .brand img{
      height:44px; width:auto; display:block;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.12));
    }
    .brandTitle{ display:flex; flex-direction:column; }
    .brandTitle b{ letter-spacing:.2px; }

    .envBadge{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.1);
      background:rgba(255,255,255,0.9);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    /* BADGE */
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.08);
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.08em;
      background:rgba(255,255,255,0.9);
      color:var(--muted);
    }

    .badge.accent{
      background: radial-gradient(circle at top left, #ffffff 0, #c1121f 60%);
      color:#ffffff;
      border-color:rgba(255,255,255,0.3);
      text-shadow:0 1px 2px rgba(0,0,0,0.35);
    }

    .badge.state-ok{
      background:linear-gradient(135deg, #14532d, #22c55e);
      color:#ecfdf5;
      border-color:rgba(16,94,57,0.7);
    }
    .badge.state-warn{
      background:linear-gradient(135deg, #92400e, #f59e0b);
      color:#fffbeb;
      border-color:rgba(146,64,14,0.7);
    }
    .badge.state-bad{
      background:linear-gradient(135deg, #7f1d1d, #ef4444);
      color:#fef2f2;
      border-color:rgba(127,29,29,0.7);
    }

    /* INPUTS */
    label{
      display:block;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.12em;
      font-weight:600;
      color:var(--muted);
      margin-bottom:4px;
    }
    input,select,textarea{
      width:100%;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:14px;
      font-family:inherit;
      background:rgba(255,255,255,0.9);
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    textarea{
      border-radius:12px;
      min-height:80px;
      resize:vertical;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--brand-red);
      box-shadow:0 0 0 1px rgba(193,18,31,0.4);
      background:#ffffff;
    }

    /* BUTTONS */
    button{
      border-radius:999px;
      padding:8px 16px;
      border:none;
      cursor:pointer;
      font-size:14px;
      font-weight:600;
      letter-spacing:0.06em;
      text-transform:uppercase;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      background:#111111;
      color:#ffffff;
      box-shadow:0 10px 24px rgba(0,0,0,0.18);
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease, opacity .12s ease;
    }
    button.small{
      font-size:11px;
      padding:5px 10px;
    }
    button.primary{
      background: radial-gradient(circle at top left, #ffffff 0, #c1121f 40%, #7f1d1d 100%);
    }
    button:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 28px rgba(0,0,0,0.22);
      opacity:0.96;
    }
    button:active{
      transform:translateY(0);
      box-shadow:0 4px 12px rgba(0,0,0,0.35);
      opacity:0.9;
    }
    button:disabled{
      opacity:0.45;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    .btnGhost{
      background:transparent;
      color:var(--muted);
      box-shadow:none;
      border:1px dashed rgba(0,0,0,0.15);
    }

    .divider{
      margin:16px 0;
      height:1px;
      background:linear-gradient(to right, rgba(0,0,0,0.16), rgba(0,0,0,0.02));
    }

    .hint{
      font-size:12px;
      color:var(--muted);
    }

    .msg{
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      margin-top:8px;
      border:1px solid transparent;
    }
    .msg.ok{
      background:#ecfdf5;
      border-color:#4ade80;
      color:#14532d;
    }
    .msg.bad{
      background:#fef2f2;
      border-color:#f97373;
      color:#7f1d1d;
    }
    .msg.warn{
      background:#fffbeb;
      border-color:#facc15;
      color:#92400e;
    }

    .hide{ display:none !important; }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      margin-top:8px;
      background:#ffffff;
      border-radius:12px;
      overflow:hidden;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid rgba(0,0,0,0.06);
      text-align:left;
      white-space:nowrap;
    }
    th{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:var(--muted);
      background:rgba(0,0,0,0.02);
    }
    td.num, th.num{
      text-align:right;
      font-variant-numeric:tabular-nums;
    }
    tr:nth-child(even) td{
      background:rgba(0,0,0,0.01);
    }

    .pillGroup{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .pill{
      padding:3px 9px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.12);
      background:rgba(255,255,255,0.85);
      font-size:11px;
    }

    .judgeFooter{
      position:sticky;
      bottom:0;
      margin:-16px;
      margin-top:16px;
      padding:10px 16px;
      padding-top:12px;
      background:linear-gradient(to top, #ffffff 70%, rgba(255,255,255,0));
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:10px;
    }

    .rangeRow{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .rangeRow input[type="range"]{
      flex:1;
    }

    input[type="range"]{
      padding:0;
      background:transparent;
    }

    /* Public */
    .publicWrap{
      max-width:540px;
      margin:0 auto;
      padding-top:20px;
    }

    .scoreCircle{
      width:64px;
      height:64px;
      border-radius:50%;
      border:3px solid var(--brand-gold);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      font-weight:700;
      margin:0 auto;
    }
.publicCard{
  position:relative;
  overflow:hidden;
  padding-top:22px;
  padding-bottom:18px;
  background-image: url("/assets/pub-bg.jpg"); /* <-- carica tu questa immagine */
  background-size: cover;
  background-position: center;
  color:#f9fafb;
  border-color: rgba(212,175,55,0.6);
  box-shadow:0 22px 60px rgba(0,0,0,0.9);
}
.publicCard::before{
  content:"";
  position:absolute;
  inset:0;
  background:radial-gradient(circle at top, rgba(0,0,0,0.15) 0, rgba(0,0,0,0.65) 55%, rgba(0,0,0,0.9) 100%);
  pointer-events:none;
}
.publicCard > *{
  position:relative;
  z-index:1;
}

.publicCard .hint{
  color:#e5e7eb;
}
.publicCard .badge.accent{
  background: radial-gradient(circle at top left, #fefce8 0, #facc15 35%, #c2410c 100%);
  color:#111827;
  text-shadow:none;
}

.publicCard .scoreCircle{
  width:72px;
  height:72px;
  border-width:4px;
  border-color:#facc15;
  background:rgba(15,23,42,0.85);
  box-shadow:0 12px 28px rgba(0,0,0,0.9);
  font-size:22px;
}

.publicCard button.primary{
  width:100%;
  justify-content:center;
  background: radial-gradient(circle at top left, #fefce8 0, #f97316 45%, #b91c1c 100%);
  color:#111827;
  box-shadow:0 18px 40px rgba(0,0,0,0.9);
}

.publicCard .brand{
  justify-content:center;
}
.publicCard .brand img{
  height:40px;
}
    /* Dark stage */
    body.dark{
      background:#050505;
      color:#f4f4f5;
    }
    body.dark .card{
      background:radial-gradient(circle at top left, #151515 0, #050505 55%, #000000 100%);
      border-color:rgba(255,255,255,0.04);
      box-shadow:
        0 20px 60px rgba(0,0,0,0.9),
        0 0 0 1px rgba(255,255,255,0.01);
    }
    body.dark .envBadge{
      background:rgba(10,10,10,0.9);
      border-color:rgba(255,255,255,0.08);
      color:#e5e5e5;
    }
    body.dark input, body.dark select, body.dark textarea{
      background:rgba(10,10,10,0.9);
      border-color:rgba(255,255,255,0.08);
      color:#e5e5e5;
    }
    body.dark input:focus, body.dark select:focus, body.dark textarea:focus{
      border-color:#d4af37;
      box-shadow:0 0 0 1px rgba(212,175,55,0.45);
      background:#050505;
    }
    body.dark button{
      background:#f5f5f5;
      color:#000000;
      box-shadow:0 12px 32px rgba(0,0,0,0.9);
    }
    body.dark button.primary{
      background: radial-gradient(circle at top left, #f4f4f5 0, #d4af37 35%, #c1121f 100%);
      color:#050505;
    }
    body.dark table{
      background:#050505;
    }
    body.dark th{
      background:#111111;
    }
    body.dark td{
      border-bottom-color:rgba(255,255,255,0.06);
    }
    body.dark .divider{
      background:linear-gradient(to right, rgba(255,255,255,0.22), rgba(255,255,255,0.02));
    }
    body.dark .msg.ok{
      background:#052e16;
      border-color:#22c55e;
      color:#bbf7d0;
    }
    body.dark .msg.bad{
      background:#450a0a;
      border-color:#f97373;
      color:#fecaca;
    }
    body.dark .msg.warn{
      background:#451a03;
      border-color:#facc15;
      color:#fed7aa;
    }
    body.dark .judgeFooter{
      background:linear-gradient(to top, var(--card-dark) 70%, rgba(0,0,0,0));
    }
    body.dark .judgeFooter .badge.ok{
      background: linear-gradient(135deg, #111111, #3a2e0d);
      color: #ffffff;
      border-color: var(--brand-gold);
    }

    /* Admin monitor charts */
    .kpi{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    canvas.chart{
      width:100%;
      max-width:520px;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(0,0,0,0.02);
      display:block;
    }
    body.dark canvas.chart{
      background:#050505;
      border-color:#333333;
    }

    @media (max-width:720px){
      .topbar{ flex-direction:column; align-items:flex-start; }
    }

    iframe{
      border-radius:16px;
      border:none;
      width:100%;
      min-height:220px;
      background:#000;
    }
  </style>
</head>
<body>
  <div class="appWrap">
    <div class="topbar">
      <div class="brand">
        <img id="brandLogo" alt="Freestyle Aerial Competition logo" />
        <div class="brandTitle">
          <b id="brandName">Freestyle Aerial Competition</b>
          <span id="brandSubtitle" class="hint">Sistema di votazione live</span>
        </div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="toggleThemeBtn" class="small btnGhost">üåô Dark Stage</button>
        <div class="envBadge">
          <span id="envBadge">Online</span>
        </div>
      </div>
    </div>

    <div id="appMain">
      <div class="row">
        <!-- LEFT: CONFIG / ADMIN -->
        <div class="col" style="min-width:280px; max-width:360px;">
          <div class="card">
            <h2>Dispositivo</h2>
            <p class="hint">Seleziona il ruolo di questo dispositivo e la giornata.</p>

            <div class="row">
              <div class="col">
                <label>Ruolo</label>
                <select id="ruolo">
                  <option value="ADMIN">Admin</option>
                  <option value="J1">Giudice 1</option>
                  <option value="J2">Giudice 2</option>
                  <option value="J3">Giudice 3</option>
                  <option value="PUBLIC">Pubblico</option>
                </select>
                <div class="hint" id="roleLockHint"></div>
              </div>

              <div class="col" style="min-width:220px; flex:0 0 auto;">
                <label>Giornata / Sessione</label>
                <select id="sessione">
                  <option value="2026-04-18_CERCHIO">18 Aprile 2026 ‚Äì Cerchio</option>
                  <option value="2026-04-19_TESSUTI">19 Aprile 2026 ‚Äì Tessuti</option>
                </select>
                <div class="hint">L‚ÄôAdmin decide quale giornata √® attiva e la impone a giudici e pubblico.</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="pillGroup">
              <span class="pill">Chi sei: <b id="who">‚Äì</b></span>
              <span class="pill">Gara: <span id="stateBadge" class="badge state-warn">In attesa</span></span>
              <span class="pill" id="freezeBadge" style="display:none;">Votazioni bloccate</span>
              <span class="pill">Sync: <span id="sync">‚Äî</span></span>
            </div>

            <p class="hint" id="stateLine" style="margin-top:8px;">In attesa attivazione giornata.</p>

            <div id="pinBox" class="hide" style="margin-top:10px;">
              <label>PIN Admin</label>
              <div class="row">
                <div class="col">
                  <input id="pin" maxlength="10" placeholder="Inserisci PIN per sbloccare Admin">
                </div>
                <div style="min-width:120px">
                  <button id="btnPin" class="small primary">Sblocca</button>
                </div>
              </div>
              <div id="pinMsg" class="msg hide"></div>
            </div>
          </div>

          <!-- ADMIN PANEL -->
          <div id="adminBody" class="hide" style="margin-top:12px;">
            <div class="card">
              <h2>Regia Admin</h2>
              <p class="hint">Gestisci andamento gara, categorie e roster atleti.</p>

              <div class="row">
                <button id="btnStartDay" class="primary">Avvia giornata</button>
                <button id="btnStopDay">Ferma giornata</button>
                <button id="btnFreeze">Blocca votazioni</button>
                <button id="btnUnfreeze" class="hide">Sblocca votazioni</button>
              </div>

              <div class="msg warn" style="margin-top:10px">
                L‚ÄôAdmin attiva <b>categoria per categoria</b> nell‚Äôordine prestabilito. Senza attivazione: giudici e pubblico non votano.
              </div>

              <div class="divider"></div>

              <div class="row">
                <div class="col">
                  <label>Categoria da attivare (ordine prestabilito)</label>
                  <select id="adminCategory"></select>
                  <div class="card" style="margin-top:10px; padding:10px;">
                    <div class="hint"><b>Roster categoria selezionata:</b> <span id="adminRosterCount">‚Äî</span></div>
                    <div class="hint" id="adminRosterList" style="margin-top:6px; white-space:pre-wrap;">‚Äî</div>
                  </div>

                  <div class="hint" style="margin-top:6px;">
                    Quando attivi una categoria, parte da Start 1 e scorre sugli atleti del roster caricato.
                  </div>
                </div>

                <div class="col" style="min-width:220px; flex:0 0 auto;">
                  <label>&nbsp;</label>
                  <div class="row">
                    <button id="btnActivateCategory" class="primary">Attiva categoria</button>
                    <button id="btnCloseCategory">Chiudi categoria</button>
                  </div>

                  <div class="divider" style="margin:12px 0;"></div>

                  <label>Atleta in uscita</label>
                  <input id="athRO" readonly placeholder="‚Äî">
                  <div class="row" style="margin-top:10px">
                    <button id="btnPrevAth">‚Üê Atleta precedente</button>
                    <button id="btnNextAth" class="primary">Atleta successivo ‚Üí</button>
                  </div>
                </div>
              </div>

              <div class="divider"></div>
              <h2 style="margin-top:0">Modifiche ultimo minuto</h2>

              <div class="row">
                <div class="col">
                  <label>Correggi nome atleta corrente</label>
                  <input id="fixAth" placeholder="Nuovo nome atleta">
                </div>
                <div style="min-width:200px">
                  <label>&nbsp;</label>
                  <button id="btnFixAth">Applica</button>
                </div>
              </div>

              <div class="row" style="margin-top:8px;">
                <div class="col">
                  <label>Correggi link video entry corrente</label>
                  <input id="fixVideo" placeholder="https://youtu.be/...">
                </div>
                <div style="min-width:200px">
                  <label>&nbsp;</label>
                  <button id="btnFixVideo">Applica</button>
                </div>
              </div>

              <!-- MONITOR CATEGORIA LIVE -->
              <div class="divider"></div>
              <h2 style="margin-top:0">Monitor categoria live</h2>

              <div class="card" style="padding:10px; margin-bottom:10px;">
                <div class="row" style="align-items:center; justify-content:space-between;">
                  <div class="kpi">
                    <span class="badge" id="adminMonCat">Categoria: ‚Äî</span>
                    <span class="badge" id="adminMonNow">Atleta: ‚Äî</span>
                  </div>
                  <span class="badge accent" id="adminMonCount">‚Äî</span>
                </div>

                <div class="row" style="margin-top:12px; flex-wrap:wrap;">
                  <div class="col" style="min-width:260px; flex:0 0 auto;">
                    <label>Progress votazioni (0/3 ‚Üí 3/3)</label>
                    <canvas id="adminPie" class="chart" width="260" height="260"></canvas>
                  </div>
                  <div class="col">
                    <label>Punteggi finali (completi)</label>
                    <canvas id="adminBars" class="chart" width="480" height="220"></canvas>
                    <div style="height:8px"></div>
                    <canvas id="adminLine" class="chart" width="480" height="220"></canvas>
                  </div>
                </div>

                <div style="margin-top:12px; overflow:auto;">
                  <table>
                    <thead>
                      <tr>
                        <th>Start</th>
                        <th>Atleta</th>
                        <th class="num">Voti</th>
                        <th class="num">Finale</th>
                      </tr>
                    </thead>
                    <tbody id="adminMonBody"></tbody>
                  </table>
                </div>
              </div>

              <div class="divider"></div>
              <h2 style="margin-top:0">Gestione roster atleti</h2>

              <div class="row">
                <div class="col">
                  <label>Giornata / Sessione</label>
                  <select id="rosterSession">
                    <option value="2026-04-18_CERCHIO">18 Aprile 2026 ‚Äì Cerchio</option>
                    <option value="2026-04-19_TESSUTI">19 Aprile 2026 ‚Äì Tessuti</option>
                  </select>
                </div>
                <div class="col">
                  <label>Categoria</label>
                  <select id="rosterCategory"></select>
                </div>
              </div>

              <div class="hint" style="margin-top:8px">
                Inserisci un atleta per riga. Puoi aggiungere opzionalmente il link al video entry YouTube separato da <code>|</code>.
                <br>Es: <code>Nome Atleta | https://youtu.be/...</code>
              </div>

              <textarea id="rosterText" style="margin-top:8px;" placeholder="Atleta 1 | https://youtu.be/...
Atleta 2
Atleta 3 | https://youtu.be/..."></textarea>

              <div class="row" style="margin-top:10px">
                <button id="btnRosterLoad">Ricarica roster</button>
                <button id="btnRosterSave" class="primary">Salva roster</button>
                <button id="btnRosterClear">Svuota</button>
              </div>

              <div class="hint" id="rosterInfo" style="margin-top:8px">‚Äî</div>
              <div id="adminMsg" class="msg hide"></div>
            </div>
          </div>
        </div>

        <!-- RIGHT: JUDGE / VIDEO / SCHEDA -->
        <div class="col">
          <div class="card">
            <h2>Atleta in gara</h2>
            <p class="hint">Scheda di gara visibile a giudici e Admin.</p>

            <div class="row">
              <div class="col">
                <label>Categoria</label>
                <input id="catRO" readonly placeholder="‚Äî">
              </div>
              <div style="min-width:120px">
                <label>Start</label>
                <input id="startRO" readonly placeholder="‚Äî">
              </div>
            </div>

            <div class="row" style="margin-top:6px;">
              <div class="col">
                <label>Nome atleta</label>
                <input id="athRO" readonly placeholder="‚Äî">
              </div>
            </div>

            <div id="videoWrap" style="margin-top:10px;">
              <div id="videoHint" class="hint">Quando l‚ÄôAdmin collega il video entry YouTube, apparir√† qui.</div>
              <div id="videoBox" class="hide"></div>
            </div>

            <div class="divider"></div>

            <h2>Valutazione giudice</h2>
            <p class="hint">
              Compila solo se sei un giudice. Ogni criterio da 0 a 10, penalit√† da 0 a 100. La penalit√† richiede <b>nota obbligatoria</b>.
            </p>

            <div id="critBody"></div>

            <div class="row" style="margin-top:8px;">
              <div class="col" style="max-width:220px;">
                <label>Penalit√† (0‚Äì100)</label>
                <input id="pen" type="number" value="0" min="0" max="100" step="0.1">
              </div>
              <div class="col">
                <label>Nota (obbligatoria se penalit√† > 0)</label>
                <textarea id="note" placeholder="Motivazione penalit√† o nota tecnica"></textarea>
              </div>
            </div>

            <div class="judgeFooter">
              <div>
                <span class="badge">Totale (dopo penalit√†)</span>
                <span class="badge accent" style="font-size:20px; padding:6px 14px;" id="tot">0.0</span>
              </div>
              <div class="row" style="gap:6px; align-items:center;">
                <span class="badge" id="submittedBadge" style="display:none;">Inviato</span>
                <button id="btnClear" class="btnGhost small">Reset scheda</button>
                <button id="btnSend" class="primary">Invia voti</button>
              </div>
            </div>

            <div id="judgeMsg" class="msg hide"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ======================
         PUBLIC
    ======================= -->
    <div id="appPublic" class="hide">
      <div class="publicWrap">
        <div class="card publicCard center">
          <div class="brand" style="justify-content:center; margin-bottom:8px">
            <img id="brandLogo2" alt="Logo" style="height:38px" />
          </div>

          <div class="badge accent" style="justify-content:center">Premio del Pubblico</div>
          <div class="hint" style="margin-top:10px">Dai il tuo voto agli atleti in gara</div>

          <div style="margin-top:14px; font-size:18px; font-weight:900" id="pubAthlete">‚Äî</div>
          <div class="hint" style="margin-top:6px" id="pubMeta">In attesa attivazione‚Ä¶</div>

          <div style="margin-top:16px">
            <div class="scoreCircle">
              <span id="pubValue">5</span>
            </div>
            <div class="rangeRow" style="margin-top:10px;">
              <span style="font-size:11px;">1</span>
              <input id="pubSlider" type="range" min="1" max="10" step="1" value="5">
              <span style="font-size:11px;">10</span>
            </div>
          </div>

          <div style="margin-top:16px;">
            <button id="pubVoteBtn" class="primary">Invia voto</button>
          </div>

          <div id="pubMsg" class="msg hide"></div>

          <div class="hint" style="margin-top:12px">
            Un solo voto per atleta su questo dispositivo.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ======================
   FIREBASE CONFIG
====================== */
const firebaseConfig = {
  apiKey: "AIzaSyB-2_KfVwjnIoS8yo__k4FZBYMQ5xN6wR0",
  authDomain: "votazioni-b93a0.firebaseapp.com",
  projectId: "votazioni-b93a0",
  storageBucket: "votazioni-b93a0.firebasestorage.app",
  messagingSenderId: "597305511112",
  appId: "1:597305511112:web:5eab508957aec0fe0969fd",
  measurementId: "G-R26TFX0KMN"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ======================
   BRAND (se vuoi cambiare nome/logo)
====================== */
const BRAND = {
  name: "Freestyle Aerial Competition",
  subtitle: "Sistema votazioni 2026",
 logoUrl: "/assets/logo.png" // sostituibile
};

/* ======================
   DOM
====================== */
const brandName = document.getElementById("brandName");
const brandSubtitle = document.getElementById("brandSubtitle");
const brandLogo = document.getElementById("brandLogo");
const brandLogo2 = document.getElementById("brandLogo2");
const envBadge = document.getElementById("envBadge");

const toggleThemeBtn = document.getElementById("toggleThemeBtn");

const appMain = document.getElementById("appMain");
const appPublic = document.getElementById("appPublic");

const ruolo = document.getElementById("ruolo");
const sessione = document.getElementById("sessione");
const roleLockHint = document.getElementById("roleLockHint");

const stateBadge = document.getElementById("stateBadge");
const stateLine = document.getElementById("stateLine");

const who = document.getElementById("who");
const freezeBadge = document.getElementById("freezeBadge");
const submittedBadge = document.getElementById("submittedBadge");
const judgeMsg = document.getElementById("judgeMsg");

const catRO = document.getElementById("catRO");
const startRO = document.getElementById("startRO");
const athRO = document.getElementById("athRO");

const videoWrap = document.getElementById("videoWrap");
const videoBox = document.getElementById("videoBox");
const videoHint = document.getElementById("videoHint");

const critBody = document.getElementById("critBody");
const pen = document.getElementById("pen");
const note = document.getElementById("note");
const tot = document.getElementById("tot");
const sync = document.getElementById("sync");
const btnSend = document.getElementById("btnSend");
const btnClear = document.getElementById("btnClear");

const pinBox = document.getElementById("pinBox");
const pin = document.getElementById("pin");
const btnPin = document.getElementById("btnPin");
const pinMsg = document.getElementById("pinMsg");

const adminBody = document.getElementById("adminBody");
const adminMsg = document.getElementById("adminMsg");

const btnStartDay = document.getElementById("btnStartDay");
const btnStopDay = document.getElementById("btnStopDay");
const btnFreeze = document.getElementById("btnFreeze");
const btnUnfreeze = document.getElementById("btnUnfreeze");

const adminCategory = document.getElementById("adminCategory");
const adminRosterCount = document.getElementById("adminRosterCount");
const adminRosterList = document.getElementById("adminRosterList");
const btnActivateCategory = document.getElementById("btnActivateCategory");
const btnCloseCategory = document.getElementById("btnCloseCategory");
const btnPrevAth = document.getElementById("btnPrevAth");
const btnNextAth = document.getElementById("btnNextAth");

const fixAth = document.getElementById("fixAth");
const fixVideo = document.getElementById("fixVideo");
const btnFixAth = document.getElementById("btnFixAth");
const btnFixVideo = document.getElementById("btnFixVideo");

const adminMonCat = document.getElementById("adminMonCat");
const adminMonNow = document.getElementById("adminMonNow");
const adminMonCount = document.getElementById("adminMonCount");
const adminMonBody = document.getElementById("adminMonBody");
const adminPie = document.getElementById("adminPie");
const adminBars = document.getElementById("adminBars");
const adminLine = document.getElementById("adminLine");

const rosterSession = document.getElementById("rosterSession");
const rosterCategory = document.getElementById("rosterCategory");
const rosterText = document.getElementById("rosterText");
const btnRosterLoad = document.getElementById("btnRosterLoad");
const btnRosterSave = document.getElementById("btnRosterSave");
const btnRosterClear = document.getElementById("btnRosterClear");
const rosterInfo = document.getElementById("rosterInfo");

const pubAthlete = document.getElementById("pubAthlete");
const pubMeta = document.getElementById("pubMeta");
const pubSlider = document.getElementById("pubSlider");
const pubValue = document.getElementById("pubValue");
const pubVoteBtn = document.getElementById("pubVoteBtn");
const pubMsg = document.getElementById("pubMsg");

/* ======================
   APPLY BRAND
====================== */
brandName.textContent = BRAND.name;
brandSubtitle.textContent = BRAND.subtitle;
brandLogo.src = BRAND.logoUrl;
brandLogo2.src = BRAND.logoUrl;

/* ======================
   UTILS
====================== */
const clamp = (x, min, max) => Number.isNaN(x) ? min : Math.max(min, Math.min(max, x));
const fmt1 = (x) => (Math.round(x*10)/10).toFixed(1);
const sum = (a) => a.reduce((p,c)=>p+c,0);
const safeId = (s) => String(s||"").trim().replaceAll(" ", "_");

function calcJudgeTotal(j){
  if (!j || !Array.isArray(j.scores)) return null;
  const s = j.scores.map(x => clamp(parseFloat(x)||0,0,10));
  const penV = clamp(parseFloat(j.penalty||0),0,100);
  return sum(s) - penV;
}
function getPerfFinal(perf){
  const j = perf && perf.judges ? perf.judges : {};
  const totals = [];
  const j1 = j.j1, j2 = j.j2, j3 = j.j3;

  const t1 = calcJudgeTotal(j1);
  const t2 = calcJudgeTotal(j2);
  const t3 = calcJudgeTotal(j3);

  if (j1 && j1.submitted && t1 != null) totals.push(t1);
  if (j2 && j2.submitted && t2 != null) totals.push(t2);
  if (j3 && j3.submitted && t3 != null) totals.push(t3);

  const votedCount = totals.length;
  const finalAvg = votedCount === 3 ? (sum(totals) / 3) : null;

  return {
    votedCount,
    t1,
    t2,
    t3,
    finalAvg
  };
}

function ctx2d(canvas){
  if (!canvas) return null;
  const c = canvas.getContext("2d");
  c.clearRect(0,0,canvas.width,canvas.height);
  return c;
}
function drawPie(canvas, counts){
  const c = ctx2d(canvas);
  if (!c) return;
  const total = counts.reduce((a,b)=>a+b,0) || 1;
  const w = canvas.width, h = canvas.height;
  const cx = w/2, cy = h/2;
  const r = Math.min(w,h)*0.38;
  const colors = ["#6b6b6b", "#c1121f", "#d4af37", "#1b5e20"];
  const labels = ["0/3","1/3","2/3","3/3"];
  let a0 = -Math.PI/2;
  for (let i=0;i<4;i++){
    const frac = counts[i]/total;
    const a1 = a0 + frac*2*Math.PI;
    c.beginPath();
    c.moveTo(cx,cy);
    c.arc(cx,cy,r,a0,a1);
    c.closePath();
    c.fillStyle = colors[i];
    c.fill();
    a0 = a1;
  }
  c.font = "12px system-ui";
  c.fillStyle = "#111";
  let y = 16;
  for (let i=0;i<4;i++){
    c.fillStyle = colors[i];
    c.fillRect(10, y-10, 10, 10);
    c.fillStyle = "#111";
    c.fillText(labels[i] + ": " + counts[i], 28, y);
    y += 18;
  }
}
function drawBars(canvas, items){
  const c = ctx2d(canvas);
  if (!c) return;
  const w = canvas.width, h = canvas.height;
  const pad = 32;
  const maxV = Math.max(1, ...items.map(it=>it.value));
  const n = Math.max(1, items.length);
  const barW = Math.max(8, (w - pad*2) / n * 0.7);
  const gap = ((w - pad*2) / n) - barW;
  c.strokeStyle = "#2a2a2a";
  c.beginPath();
  c.moveTo(pad, pad);
  c.lineTo(pad, h-pad);
  c.lineTo(w-pad, h-pad);
  c.stroke();
  c.font = "11px system-ui";
  c.fillStyle = "#111";
  items.forEach((it, i) => {
    const x = pad + i*(barW+gap) + gap/2;
    const bh = (h - pad*2) * (it.value / maxV);
    const y = (h - pad) - bh;
    c.fillStyle = "#d4af37";
    c.fillRect(x, y, barW, bh);
    c.fillStyle = "#111";
    c.fillText(it.xLabel, x, h - 12);
  });
  c.fillText("Finale (media) ‚Äì completi", pad, 16);
}
function drawLine(canvas, items){
  const c = ctx2d(canvas);
  if (!c) return;
  const w = canvas.width, h = canvas.height;
  const pad = 32;
  if (!items.length){
    c.clearRect(0,0,w,h);
    return;
  }
  const xs = items.map(it=>it.x);
  const ys = items.map(it=>it.y);
  const minX = Math.min(...xs);
  const maxX = Math.max(...xs);
  const minY = Math.min(...ys);
  const maxY = Math.max(...ys);
  const xScale = (val)=> pad + ((val-minX) / (maxX-minX || 1)) * (w-pad*2);
  const yScale = (val)=> (h-pad) - ((val-minY) / (maxY-minY || 1)) * (h-pad*2);
  c.strokeStyle = "#2a2a2a";
  c.beginPath();
  c.moveTo(pad, pad);
  c.lineTo(pad, h-pad);
  c.lineTo(w-pad, h-pad);
  c.stroke();
  c.strokeStyle = "#c1121f";
  c.lineWidth = 2;
  c.beginPath();
  items.forEach((it,i)=>{
    const x = xScale(it.x);
    const y = yScale(it.y);
    if (i===0) c.moveTo(x,y); else c.lineTo(x,y);
  });
  c.stroke();
  c.fillStyle = "#c1121f";
  items.forEach(it=>{
    const x = xScale(it.x), y = yScale(it.y);
    c.beginPath();
    c.arc(x,y,3,0,2*Math.PI);
    c.fill();
  });
  c.font = "11px system-ui";
  c.fillStyle = "#111";
  c.fillText("Andamento punteggi ‚Äì completi", pad, 16);
}

function getUrlRole(){
  const p = new URLSearchParams(location.search);
  const r = (p.get("role")||"").toUpperCase().trim();
  return ["ADMIN","J1","J2","J3","PUBLIC"].includes(r) ? r : null;
}
function roleKey(v){
  return v==="J1"?"j1":(v==="J2"?"j2":(v==="J3"?"j3":null));
}

function rosterDocId(session, category){ return safeId(`${session}__${category}`); }
function rosterRef(session, category){ return db.collection("rosters").doc(rosterDocId(session, category)); }
function stateRef(session){ return db.collection("state").doc(String(session)); }
function metaRef(){ return db.collection("meta").doc("global"); }
function standingsRef(session, category){ return db.collection("standings").doc(`${session}__${category}`); }

function perfId(session, category, startNum){ return safeId(`${session}__${category}__${startNum}`); }
function perfRef(session, category, startNum){ return db.collection("performances").doc(perfId(session, category, startNum)); }

// Public device lock
const LS_DEVICE_ID = "fac_pub_device_v3";
function getDeviceId(){
  let id = localStorage.getItem(LS_DEVICE_ID);
  if (!id){
    id = "dev_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    localStorage.setItem(LS_DEVICE_ID, id);
  }
  return id;
}
function localVotedKey(perfIdStr){ return `fac_voted_${perfIdStr}`; }

// Video: YouTube embed
function toYouTubeEmbed(url){
  if (!url) return null;
  const u = String(url).trim();
  let m = u.match(/youtu\.be\/([A-Za-z0-9_-]{6,})/);
  if (m) return `https://www.youtube.com/embed/${m[1]}`;
  m = u.match(/[?&]v=([A-Za-z0-9_-]{6,})/);
  if (m) return `https://www.youtube.com/embed/${m[1]}`;
  m = u.match(/youtube\.com\/embed\/([A-Za-z0-9_-]{6,})/);
  if (m) return `https://www.youtube.com/embed/${m[1]}`;
  return null;
}

/* ======================
   PUBLIC MODE / MAIN MODE
====================== */
function showPublicMode(){
  appMain.classList.add("hide");
  appPublic.classList.remove("hide");
}
function showMainMode(){
  appPublic.classList.add("hide");
  appMain.classList.remove("hide");
}

function lockRoleAndSessionForNonAdmin(){
  const r = ruolo.value;
  if (["J1","J2","J3","PUBLIC"].includes(r)){
    ruolo.disabled = true;
    sessione.disabled = true;
    roleLockHint.textContent = "Ruolo e giornata gestiti dall‚ÄôAdmin";
  } else if (r === "ADMIN"){
    ruolo.disabled = false;
    if (!forcedSession){
      sessione.disabled = false;
      roleLockHint.textContent = "";
    }
  }
}

function refreshMode(){
  who.textContent = ruolo.value;
  lockRoleAndSessionForNonAdmin();

  if (isPublic()) showPublicMode();
  else showMainMode();

  if (isAdmin()){
    if (isAdminUnlocked()) unlockAdmin();
    else lockAdmin();
  } else {
    pinBox.classList.add("hide");
    adminBody.classList.add("hide");
  }
}

/* ======================
   DARK STAGE TOGGLE (LOCAL)
====================== */
const THEME_KEY = "fac_theme";
function applyTheme(theme){
  if (theme === "dark"){
    document.body.classList.add("dark");
    toggleThemeBtn.textContent = "‚òÄÔ∏è Light Mode";
  } else {
    document.body.classList.remove("dark");
    toggleThemeBtn.textContent = "üåô Dark Stage";
  }
  localStorage.setItem(THEME_KEY, theme);
}
applyTheme(localStorage.getItem(THEME_KEY) || "light");
toggleThemeBtn.onclick = () => {
  const next = document.body.classList.contains("dark") ? "light" : "dark";
  applyTheme(next);
};

/* ======================
   RULES
====================== */
const ADMIN_PIN = "2478";
const CRITERI = ["Coreografia","Tecnica","Triks","Immagine","Presenza scenica","Performance generale"];

const CATEGORY_ORDER = [
  "Junior A",
  "Junior B ‚Äì Base",
  "Teen ‚Äì Base",
  "Adulti ‚Äì Base",
  "Junior B ‚Äì Intermedio",
  "Teen ‚Äì Intermedio",
  "Adulti ‚Äì Intermedio",
  "Junior B ‚Äì Avanzato",
  "Teen ‚Äì Avanzato",
  "Adulti ‚Äì Avanzato",
  "Istruttori / Allenatori",
  "Professional",
  "Elite",
  "Duo"
];

/* ======================
   ADMIN AUTH
====================== */
const LS_ADMIN_OK = "fac_admin_ok_v3";
const isAdmin = () => ruolo.value === "ADMIN";
const isPublic = () => ruolo.value === "PUBLIC";
const isJudge = () => ["J1","J2","J3"].includes(ruolo.value);
const isAdminUnlocked = () => localStorage.getItem(LS_ADMIN_OK)==="1";

function unlockAdmin(){
  localStorage.setItem(LS_ADMIN_OK,"1");
  pinBox.classList.add("hide");
  adminBody.classList.remove("hide");
}
function lockAdmin(){
  localStorage.removeItem(LS_ADMIN_OK);
  adminBody.classList.add("hide");
  pinBox.classList.remove("hide");
}

btnPin.onclick = () => {
  if (pin.value.trim() === ADMIN_PIN){
    showMsg(pinMsg, "ok", "Admin sbloccato su questo dispositivo.");
    unlockAdmin();
    refreshMode();
  } else {
    showMsg(pinMsg, "bad", "PIN errato.");
  }
};

/* ======================
   MESSAGES
====================== */
function showMsg(el, type, txt){
  el.classList.remove("hide","ok","bad","warn");
  el.classList.add(type);
  el.textContent = txt;
}
function hideMsg(el){
  el.classList.add("hide");
  el.textContent = "";
  el.classList.remove("ok","bad","warn");
}

/* ======================
   CRITERIA BUILD
====================== */
let critInputs = [];
function buildCriteria(){
  critBody.innerHTML = "";
  critInputs = [];
  CRITERI.forEach((c,i) => {
    const row = document.createElement("div");
    row.className = "row";
    row.style.marginTop = "6px";

    const col1 = document.createElement("div");
    col1.className = "col";
    const lbl = document.createElement("label");
    lbl.textContent = c;
    col1.appendChild(lbl);

    const col2 = document.createElement("div");
    col2.style.minWidth = "120px";
    const inp = document.createElement("input");
    inp.type = "number";
    inp.min = "0";
    inp.max = "10";
    inp.step = "0.1";
    inp.value = "0";
    inp.oninput = recalc;
    col2.appendChild(inp);

    row.appendChild(col1);
    row.appendChild(col2);
    critBody.appendChild(row);
    critInputs.push(inp);
  });
}

/* ======================
   VIDEO
====================== */
function clearVideo(){
  videoBox.innerHTML = "";
  videoBox.classList.add("hide");
  videoHint.classList.remove("hide");
}
function renderVideo(url){
  const emb = toYouTubeEmbed(url);
  if (!emb){
    clearVideo();
    return;
  }
  videoBox.innerHTML = `<iframe src="${emb}" allowfullscreen></iframe>`;
  videoBox.classList.remove("hide");
  videoHint.classList.add("hide");
}

/* ======================
   CALC TOTAL
====================== */
function recalc(){
  const scores = critInputs.map(i => clamp(parseFloat(i.value),0,10));
  const penalty = clamp(parseFloat(pen.value),0,100);
  const total = sum(scores) - penalty;
  tot.textContent = fmt1(total);
}

/* ======================
   CATEGORY MENUS
====================== */
function fillCategorySelect(sel){
  sel.innerHTML = CATEGORY_ORDER.map((c,i)=>`<option value="${c}">${i+1}. ${c}</option>`).join("");
}
fillCategorySelect(adminCategory);
fillCategorySelect(rosterCategory);

// preview roster in Admin when selecting a category
adminCategory.onchange = () => refreshAdminRosterPreview();

/* ======================
   STATE + PERFORMANCE (CORE)
====================== */
let unsubState = null;let unsubMeta = null;
let forcedSession = null; // sessione imposta dall'Admin tramite Firestore

let currentState = null;

let unsubPerf = null;
let unsubAdminPerf = null;
let unsubAdminMonitor = null;
let lastAutoPerfKey = null;

let lastPerfDoc = null;
function listenMeta(){
  if (unsubMeta) unsubMeta();
  unsubMeta = metaRef().onSnapshot((snap) => {
    if (!snap.exists) return;
    const d = snap.data() || {};
    const s = d.activeSession;

    // Per Giudici e Pubblico: sessione forzata
    if (!isAdmin()){
      if (s && sessione.value !== s){
        forcedSession = s;
        sessione.value = s;
        sessione.disabled = true;
        roleLockHint.textContent = "Giornata gestita dall‚ÄôAdmin";
        listenState(); // ricollega lo state listener sulla sessione corretta
        if (isJudge()) listenPerformanceForJudges();
      } else {
        sessione.disabled = true;
        roleLockHint.textContent = "Giornata gestita dall‚ÄôAdmin";
      }
    } else {
      // Admin pu√≤ scegliere
      sessione.disabled = false;
    }
  });
}

function listenState(){
  if (unsubState) unsubState();
  unsubState = stateRef(sessione.value).onSnapshot((snap) => {
    currentState = snap.exists ? snap.data() : null;

    if (isAdmin() && isAdminUnlocked()){
      listenAdminAutoAdvance();
      listenAdminMonitor();
    } else {
      if (unsubAdminPerf){ unsubAdminPerf(); unsubAdminPerf = null; }
      if (unsubAdminMonitor){ unsubAdminMonitor(); unsubAdminMonitor = null; }
    }

    refreshFromState();
  });
}

function listenAdminAutoAdvance(){
  // Chiude eventuale listener precedente
  if (unsubAdminPerf){ unsubAdminPerf(); unsubAdminPerf = null; }

  // Solo Admin sbloccato
  if (!isAdmin() || !isAdminUnlocked()) return;

  // Serve una gara e una categoria attiva, e non deve essere bloccata
  if (!currentState || currentState.active !== true) return;
  if (currentState.categoryActive !== true) return;
  if (currentState.locked === true) return;

  const cat = currentState.categoryName;
  const st = currentState.start;
  if (!cat || !st) return;

  const ref = perfRef(sessione.value, cat, st);

  unsubAdminPerf = ref.onSnapshot(async (snap) => {
    const d = snap.exists ? snap.data() : null;
    const j = d?.judges || {};

    const ok1 = j.j1?.submitted === true;
    const ok2 = j.j2?.submitted === true;
    const ok3 = j.j3?.submitted === true;

    // Se non sono 3/3, non facciamo nulla
    if (!(ok1 && ok2 && ok3)) return;

    // Evita doppio passaggio sullo stesso atleta
    const perfKey = `${sessione.value}__${cat}__${st}`;
    if (lastAutoPerfKey === perfKey) return;
    lastAutoPerfKey = perfKey;

    // Piccola pausa (anti-rimbalzo)
    setTimeout(async () => {
      // Ricontrollo stato attuale prima di passare
      const stSnap = await stateRef(sessione.value).get();
      const sdata = stSnap.exists ? stSnap.data() : null;

      if (!sdata) return;
      if (sdata.locked === true) return;
      if (sdata.categoryActive !== true) return;

      // Se nel frattempo Admin ha cambiato atleta/categoria, non facciamo nulla
      if (sdata.categoryName !== cat) return;
      if (String(sdata.start) !== String(st)) return;

      // PASSA AL SUCCESSIVO
      await adminStepAthlete(+1);
    }, 600);
  });
}

function refreshFromState(){
  const st = currentState;

  if (!st || st.active !== true){
    setStateBadge("warn", "In attesa");
    stateLine.textContent = "Gara non attiva.";
    freezeBadge.classList.add("hide");

    catRO.value = ""; startRO.value = ""; athRO.value = "";
    clearVideo();

    if (isJudge()){
      setJudgeEnabled(false);
      showMsg(judgeMsg, "warn", "In attesa attivazione Admin.");
    }
    if (isPublic()){
      applyPublic(null, "In attesa attivazione giornata‚Ä¶");
    }

    if (isAdmin() && isAdminUnlocked()){
      btnUnfreeze.classList.add("hide");
      btnFreeze.classList.remove("hide");
    }
    return;
  }

  const frozen = st.locked === true;
  freezeBadge.classList.toggle("hide", !frozen);

  setStateBadge(frozen ? "bad" : "ok", frozen ? "Bloccata" : "Attiva");

  if (st.categoryActive !== true){
    stateLine.textContent = "In attesa prossima categoria‚Ä¶";
    catRO.value = ""; startRO.value = ""; athRO.value = "";
    clearVideo();

    if (isJudge()){
      setJudgeEnabled(false);
      showMsg(judgeMsg, "warn", frozen ? "Votazioni bloccate dall‚ÄôAdmin." : "In attesa attivazione categoria.");
    }
    if (isPublic()){
      applyPublic(null, frozen ? "Votazioni momentaneamente bloccate." : "In attesa prossima categoria‚Ä¶");
    }

    if (isAdmin() && isAdminUnlocked()){
      btnUnfreeze.classList.toggle("hide", !frozen);
      btnFreeze.classList.toggle("hide", frozen);
    }
    return;
  }

  stateLine.textContent = `${st.categoryName || "‚Äî"} ‚Ä¢ Start ${st.start || "‚Äî"} ‚Ä¢ ${st.athleteName || "‚Äî"}`;
  if (isAdmin() && adminMonNow){ adminMonNow.textContent = "Atleta: " + (st.athleteName || "‚Äî"); }

  catRO.value = st.categoryName || "";
  startRO.value = st.start || "";
  athRO.value = st.athleteName || "";

  if (st.videoUrl) renderVideo(st.videoUrl);
  else clearVideo();

  if (isJudge()){
    if (frozen){
      setJudgeEnabled(false);
      showMsg(judgeMsg, "bad", "Votazioni bloccate dall‚ÄôAdmin.");
    } else {
      // enable depends on performance submitted status; perf listener will manage
      hideMsg(judgeMsg);
    }
  }

  if (isPublic()){
    if (frozen){
      applyPublic(null, "Votazioni momentaneamente bloccate.");
    } else {
      applyPublic(st, null);
    }
  }

  if (isAdmin() && isAdminUnlocked()){
    btnUnfreeze.classList.toggle("hide", !frozen);
    btnFreeze.classList.toggle("hide", frozen);
  }

  // ensure judges follow the current athlete
  if (isJudge()) listenPerformanceForJudges();
}

function setStateBadge(type, txt){
  stateBadge.classList.remove("state-ok","state-warn","state-bad");
  if (type==="ok") stateBadge.classList.add("state-ok");
  else if (type==="bad") stateBadge.classList.add("state-bad");
  else stateBadge.classList.add("state-warn");
  stateBadge.textContent = txt;
}

/* ======================
   PERFORMANCE LISTENER (JUDGES)
====================== */
function listenPerformanceForJudges(){
  if (!isJudge()) return;
  if (unsubPerf) unsubPerf();
  if (!currentState || currentState.categoryActive !== true) return;

  const cat = currentState.categoryName;
  const st = currentState.start;
  if (!cat || !st) return;

  const ref = perfRef(sessione.value, cat, st);
  unsubPerf = ref.onSnapshot((snap) => {
    lastPerfDoc = snap.exists ? snap.data() : null;
    const d = lastPerfDoc;
    const rk = roleKey(ruolo.value);

    if (!d){
      setJudgeEnabled(false);
      showMsg(judgeMsg, "bad", "Scheda non pronta.");
      return;
    }

    const j = d.judges || {};
    const my = j[rk];

    const frozen = currentState?.locked === true;
    if (frozen){
      setJudgeEnabled(false);
      showMsg(judgeMsg, "bad", "Votazioni bloccate dall‚ÄôAdmin.");
      return;
    }

    if (my?.submitted){
      setJudgeEnabled(false);
      submittedBadge.style.display = "inline-flex";
      showMsg(judgeMsg, "ok", "Hai gi√† inviato: voti definitivi.");
      // aggiorna campi con quello che avevi mandato
      if (Array.isArray(my.scores)){
        critInputs.forEach((inp,idx)=>{
          inp.value = my.scores[idx] != null ? my.scores[idx] : 0;
        });
      }
      pen.value = my.penalty != null ? my.penalty : 0;
      note.value = my.note || "";
      recalc();
      return;
    }

    // Non ancora inviato
    submittedBadge.style.display = "none";
    setJudgeEnabled(true);
    hideMsg(judgeMsg);

    // non sovrascriviamo se il giudice sta gi√† digitando
    recalc();
  });
}

function setJudgeEnabled(on){
  critInputs.forEach(i => i.disabled = !on);
  pen.disabled = !on;
  note.disabled = !on;
  btnSend.disabled = !on;
  btnClear.disabled = !on;
}

/* ======================
   ADMIN: ROSTER LOAD/SAVE
====================== */
async function readRoster(session, category){
  const snap = await rosterRef(session, category).get();
  if (!snap.exists) return [];
  const d = snap.data() || {};
  const names = Array.isArray(d.names) ? d.names : [];
  return names.map(x => {
    if (typeof x === "string") return { name: x.trim(), videoUrl: "" };
    return { name: String(x.name||"").trim(), videoUrl: String(x.videoUrl||"").trim() };
  }).filter(x => x.name);
}

async function writeRoster(session, category, list){
  const doc = {
    session,
    category,
    names: list.map(x => ({ name:x.name, videoUrl:x.videoUrl||"" })),
    updatedAt: Date.now()
  };
  await rosterRef(session, category).set(doc, { merge:true });
}

function parseRosterText(raw){
  const lines = String(raw||"").split(/\r?\n/);
  const out = [];
  for (const line of lines){
    const trimmed = line.trim();
    if (!trimmed) continue;
    const parts = trimmed.split("|");
    const name = parts[0].trim();
    const videoUrl = (parts[1]||"").trim();
    if (name){
      out.push({ name, videoUrl });
    }
  }
  return out;
}

async function refreshAdminRosterPreview(){
  const sess = rosterSession.value;
  const cat = rosterCategory.value;
  const list = await readRoster(sess, cat);
  adminRosterCount.textContent = list.length;
  if (!list.length){
    adminRosterList.textContent = "Nessun atleta presente nel roster.";
  } else {
    adminRosterList.textContent = list.map((x,i)=>`${i+1}. ${x.name}${x.videoUrl ? " | " + x.videoUrl : ""}`).join("\n");
  }
}

btnRosterLoad.onclick = async () => {
  const sess = rosterSession.value;
  const cat = rosterCategory.value;
  const list = await readRoster(sess, cat);
  rosterText.value = list.map(x => x.videoUrl ? `${x.name} | ${x.videoUrl}` : x.name).join("\n");
  rosterInfo.textContent = `Caricati ${list.length} atleti da Firestore.`;
};

btnRosterSave.onclick = async () => {
  const sess = rosterSession.value;
  const cat = rosterCategory.value;
  const list = parseRosterText(rosterText.value);
  await writeRoster(sess, cat, list);
  rosterInfo.textContent = `Salvati ${list.length} atleti per ${cat}.`;
  await refreshAdminRosterPreview();
};

btnRosterClear.onclick = () => {
  rosterText.value = "";
  rosterInfo.textContent = "‚Äî";
};

/* ======================
   ADMIN: COMPETITION FLOW
====================== */
async function ensurePerformanceDoc(categoryName, startNum, athleteName, videoUrl){
  const ref = perfRef(sessione.value, categoryName, startNum);
  await ref.set({
    sessione: sessione.value,
    categoria: categoryName,
    start: String(startNum),
    atleta: athleteName || "",
    videoUrl: videoUrl || "",
    status: { closed:false }
  }, { merge:true });
}

async function adminStartDay(){
  await metaRef().set({
    activeSession: sessione.value,
    updatedAt: Date.now()
  }, { merge:true });

  const sess = sessione.value;
  await stateRef(sess).set({
    active: true,
    locked: false,
    categoryActive: false,
    categoryIndex: null,
    categoryName: null,
    start: null,
    athleteName: null,
    videoUrl: null,
    updatedAt: Date.now()
  }, { merge:true });
  showMsg(adminMsg, "ok", "Giornata attivata. Ora seleziona una categoria e avviala.");
}

async function adminStopDay(){
  const sess = sessione.value;
  await stateRef(sess).set({
    active: false,
    categoryActive: false,
    locked: false,
    updatedAt: Date.now()
  }, { merge:true });
  showMsg(adminMsg, "warn", "Giornata fermata.");
}

async function adminFreeze(on){
  const sess = sessione.value;
  await stateRef(sess).set({
    locked: !!on,
    updatedAt: Date.now()
  }, { merge:true });
  showMsg(adminMsg, on ? "bad" : "ok", on ? "Votazioni bloccate." : "Votazioni sbloccate.");
}

async function adminActivateCategory(){
  const sess = sessione.value;
  const catName = adminCategory.value;
  const idx = CATEGORY_ORDER.indexOf(catName);
  if (idx < 0){
    showMsg(adminMsg, "bad", "Categoria non valida.");
    return;
  }

  const roster = await readRoster(sess, catName);
  if (!roster.length){
    showMsg(adminMsg, "bad", "Nessun atleta nel roster di questa categoria.");
    return;
  }

  const first = roster[0];
  const athlete = first.name;
  const videoUrl = first.videoUrl || "";

  await stateRef(sess).set({
    active: true,
    locked: false,
    categoryActive: true,
    categoryIndex: idx,
    categoryName: catName,
    start: "1",
    athleteName: athlete,
    videoUrl: videoUrl,
    updatedAt: Date.now()
  }, { merge:true });

  await ensurePerformanceDoc(catName, 1, athlete, videoUrl);

  showMsg(adminMsg, "ok", `Categoria attivata: ${catName} (Start 1).`);
}

async function adminCloseCategory(){
  const sess = sessione.value;
  await stateRef(sess).set({
    categoryActive: false,
    start: null,
    athleteName: null,
    videoUrl: null,
    updatedAt: Date.now()
  }, { merge:true });
  showMsg(adminMsg, "warn", "Categoria chiusa. Attiva la prossima quando vuoi.");
}

async function adminStepAthlete(delta){
  const sess = sessione.value;
  const snap = await stateRef(sess).get();
  if (!snap.exists) return;
  const st = snap.data();

  if (st.active !== true){
    showMsg(adminMsg, "bad", "Giornata non attiva.");
    return;
  }
  if (st.categoryActive !== true){
    showMsg(adminMsg, "bad", "Nessuna categoria attiva.");
    return;
  }

  const cat = st.categoryName;
  const idx = CATEGORY_ORDER.indexOf(cat);
  if (idx < 0){
    showMsg(adminMsg, "bad", "Categoria non valida.");
    return;
  }

  const roster = await readRoster(sess, cat);
  if (!roster.length){
    showMsg(adminMsg, "bad", "Roster vuoto.");
    return;
  }

  let cur = parseInt(st.start || "1", 10) || 1;
  let next = cur + delta;
  if (next < 1) next = 1;
  if (next > roster.length) next = roster.length;

  const athlete = roster[next-1].name;
  const videoUrl = roster[next-1].videoUrl || "";

  await stateRef(sess).set({
    categoryActive: true,
    categoryIndex: idx,
    categoryName: cat,
    start: String(next),
    athleteName: athlete,
    videoUrl: videoUrl,
    updatedAt: Date.now()
  }, { merge:true });

  await ensurePerformanceDoc(cat, next, athlete, videoUrl);

  showMsg(adminMsg, "ok", `Passato all‚Äôatleta ${next}/${roster.length}: ${athlete}.`);
}

async function adminFixAthleteName(){
  const sess = sessione.value;
  const st = currentState;
  if (!st?.categoryName || !st?.start){
    showMsg(adminMsg, "bad", "Nessuna scheda attiva da correggere.");
    return;
  }
  const newName = (fixAth.value||"").trim();
  if (!newName){
    showMsg(adminMsg, "bad", "Inserisci un nome valido.");
    return;
  }

  const roster = await readRoster(sess, st.categoryName);
  const idx = parseInt(st.start||"1",10)-1;
  if (idx>=0 && idx<roster.length){
    roster[idx].name = newName;
    await writeRoster(sess, st.categoryName, roster);
  }

  await stateRef(sess).set({
    athleteName: newName,
    updatedAt: Date.now()
  }, { merge:true });

  await perfRef(sess, st.categoryName, st.start).set({ atleta: newName }, { merge:true });

  showMsg(adminMsg, "ok", "Nome atleta aggiornato.");
  fixAth.value = "";
}

async function adminFixVideoUrl(){
  const sess = sessione.value;
  const url = (fixVideo.value||"").trim();

  const st = currentState;
  if (!st?.categoryName || !st?.start){
    showMsg(adminMsg, "bad", "Nessuna scheda attiva da correggere.");
    return;
  }

  await stateRef(sess).set({ videoUrl: url, updatedAt: Date.now() }, { merge:true });
  await perfRef(sess, st.categoryName, st.start).set({ videoUrl: url }, { merge:true });

  showMsg(adminMsg, "ok", "Video entry aggiornato.");
  fixVideo.value = "";
}

btnStartDay.onclick = adminStartDay;
btnStopDay.onclick = adminStopDay;
btnFreeze.onclick = () => adminFreeze(true);
btnUnfreeze.onclick = () => adminFreeze(false);

btnActivateCategory.onclick = adminActivateCategory;
btnCloseCategory.onclick = adminCloseCategory;
btnPrevAth.onclick = () => adminStepAthlete(-1);
btnNextAth.onclick = () => adminStepAthlete(+1);

btnFixAth.onclick = adminFixAthleteName;
btnFixVideo.onclick = adminFixVideoUrl;

function clearAdminMonitor(){
  if (adminMonCat) adminMonCat.textContent = "Categoria: ‚Äî";
  if (adminMonNow) adminMonNow.textContent = "Atleta: ‚Äî";
  if (adminMonCount) adminMonCount.textContent = "‚Äî";
  if (adminMonBody) adminMonBody.innerHTML = "";
  if (adminPie) ctx2d(adminPie);
  if (adminBars) ctx2d(adminBars);
  if (adminLine) ctx2d(adminLine);
}

function updateAdminMonitor(perfDocs){
  if (!adminMonBody) return;

  adminMonCount.textContent = perfDocs.length
    ? perfDocs.length + " performance"
    : "Nessuna performance";

  const rows = perfDocs.map(p => {
    const finalTxt = (typeof p.finalAvg === "number") ? fmt1(p.finalAvg) : "‚Äî";
    const votesTxt = (p.votedCount != null) ? (p.votedCount + "/3") : "‚Äî";
    return `<tr>
      <td>${p.startNum}</td>
      <td>${(p.atleta || "").replace(/[<>]/g,"")}</td>
      <td class="num">${votesTxt}</td>
      <td class="num">${finalTxt}</td>
    </tr>`;
  }).join("");
  adminMonBody.innerHTML = rows || "";

  // grafici
  let c0=0,c1=0,c2=0,c3=0;
  const bars = [];
  const line = [];

  perfDocs.forEach(p=>{
    const vc = p.votedCount || 0;
    if (vc === 0) c0++;
    else if (vc === 1) c1++;
    else if (vc === 2) c2++;
    else c3++;

    if (typeof p.finalAvg === "number"){
      bars.push({ xLabel: String(p.startNum), value: p.finalAvg });
      line.push({ x: p.startNum, y: p.finalAvg });
    }
  });

  drawPie(adminPie, [c0,c1,c2,c3]);

  bars.sort((a,b)=>Number(a.xLabel)-Number(b.xLabel));
  line.sort((a,b)=>a.x-b.x);

  drawBars(adminBars, bars);
  drawLine(adminLine, line);
}

function listenAdminMonitor(){
  if (unsubAdminMonitor){ unsubAdminMonitor(); unsubAdminMonitor = null; }
  clearAdminMonitor();

  if (!isAdmin() || !isAdminUnlocked()) return;
  if (!currentState || currentState.active !== true) return;
  if (currentState.categoryActive !== true) return;

  const sess = sessione.value;
  const cat = currentState.categoryName;
  if (!sess || !cat) return;

  if (adminMonCat) adminMonCat.textContent = "Categoria: " + cat;

  const q = db.collection("performances")
    .where("sessione","==",sess)
    .where("categoria","==",cat);

  unsubAdminMonitor = q.onSnapshot((qs) => {
    const perfDocs = [];
    qs.forEach(doc => {
      const d = doc.data() || {};
      const fin = getPerfFinal(d);
      const startNum = parseInt(d.start || "0", 10) || 0;
      perfDocs.push({
        startNum,
        atleta: d.atleta || "",
        votedCount: fin.votedCount,
        t1: fin.t1,
        t2: fin.t2,
        t3: fin.t3,
        finalAvg: fin.finalAvg
      });
    });
    perfDocs.sort((a,b)=> a.startNum - b.startNum);
    updateAdminMonitor(perfDocs);
  });
}

/* ======================
   JUDGE SUBMIT
====================== */
btnSend.onclick = async () => {
  if (!isJudge()) return;

  if (!currentState || currentState.active !== true){
    showMsg(judgeMsg, "warn", "In attesa attivazione Admin.");
    return;
  }
  if (currentState.locked === true){
    showMsg(judgeMsg, "bad", "Votazioni bloccate dall‚ÄôAdmin.");
    return;
  }
  if (currentState.categoryActive !== true){
    showMsg(judgeMsg, "warn", "Nessuna categoria attiva.");
    return;
  }

  const rk = roleKey(ruolo.value);
  const cat = currentState.categoryName;
  const st = currentState.start;

  if (!cat || !st){
    showMsg(judgeMsg, "bad", "Scheda non pronta.");
    return;
  }

  const ref = perfRef(sessione.value, cat, st);
  const snap = await ref.get();
  const d = snap.exists ? snap.data() : null;
  if (d?.judges?.[rk]?.submitted === true){
    showMsg(judgeMsg, "ok", "Hai gi√† inviato: definitivo.");
    return;
  }

  const scores = critInputs.map(i => +fmt1(clamp(parseFloat(i.value),0,10)));
  const penalty = +fmt1(clamp(parseFloat(pen.value),0,100));
  const nt = (note.value||"").trim();

  if (penalty > 0 && !nt){
    showMsg(judgeMsg, "bad", "Penalit√† > 0: nota obbligatoria.");
    note.focus();
    return;
  }

  await ref.set({
    judges: { [rk]: { scores, penalty, note: nt, submitted:true, submittedAt: Date.now() } }
  }, { merge:true });

  sync.textContent = "Inviato";
  showMsg(judgeMsg, "ok", "Voti inviati. Grazie.");
};

btnClear.onclick = () => {
  if (!isJudge()) return;
  critInputs.forEach(i => i.value = "0");
  pen.value = "0";
  note.value = "";
  recalc();
};

/* ======================
   PUBLIC
====================== */
function showPub(type, txt){
  pubMsg.classList.remove("hide","ok","bad","warn");
  pubMsg.classList.add(type);
  pubMsg.textContent = txt;
}
function hidePub(){
  pubMsg.classList.add("hide");
  pubMsg.textContent = "";
  pubMsg.classList.remove("ok","bad","warn");
}
pubSlider.oninput = () => { pubValue.textContent = String(pubSlider.value); };

function applyPublic(st, forcedMessage){
  if (forcedMessage){
    pubMeta.textContent = forcedMessage;
    pubAthlete.textContent = "‚Äî";
    pubVoteBtn.disabled = true;
    hidePub();
    return;
  }

  if (!st || st.active !== true){
    pubMeta.textContent = "In attesa attivazione giornata‚Ä¶";
    pubAthlete.textContent = "‚Äî";
    pubVoteBtn.disabled = true;
    hidePub();
    return;
  }

  if (st.locked === true){
    pubMeta.textContent = "Votazioni momentaneamente bloccate.";
    pubAthlete.textContent = "‚Äî";
    pubVoteBtn.disabled = true;
    hidePub();
    return;
  }

  if (st.categoryActive !== true){
    pubMeta.textContent = "In attesa prossima categoria‚Ä¶";
    pubAthlete.textContent = "‚Äî";
    pubVoteBtn.disabled = true;
    hidePub();
    return;
  }

  pubAthlete.textContent = st.athleteName || "‚Äî";
  pubMeta.textContent = `${st.categoryName || "‚Äî"} ‚Ä¢ Start ${st.start || "‚Äî"}`;
  pubVoteBtn.disabled = false;
  hidePub();
}

async function sendPublicVote(){
  if (!currentState || currentState.active !== true || currentState.categoryActive !== true){
    showPub("warn", "In attesa attivazione categoria.");
    return;
  }
  if (currentState.locked === true){
    showPub("bad", "Votazioni bloccate dall‚ÄôAdmin.");
    return;
  }

  const sess = sessione.value;
  const cat = currentState.categoryName;
  const st = currentState.start;
  if (!sess || !cat || !st){
    showPub("bad", "Scheda non pronta.");
    return;
  }

  const perfIdStr = perfId(sess, cat, st);
  const docRef = voteDocRef(perfIdStr);

  const localKey = localVotedKey(perfIdStr);
  if (localStorage.getItem(localKey)==="1"){
    showPub("warn", "Hai gi√† votato questo atleta da questo dispositivo.");
    return;
  }

  const snap = await docRef.get();
  if (snap.exists){
    const d = snap.data() || {};
    if (d.deviceId === getDeviceId()){
      showPub("warn", "Hai gi√† votato questo atleta da questo dispositivo.");
      localStorage.setItem(localKey,"1");
      return;
    }
  }

  const val = parseInt(pubSlider.value,10) || 5;
  await docRef.set({
    perfId: perfIdStr,
    sessione: sess,
    categoria: cat,
    start: String(st),
    deviceId: getDeviceId(),
    voto: val,
    createdAt: Date.now()
  });

  localStorage.setItem(localKey,"1");
  showPub("ok", "Grazie! Il tuo voto √® stato registrato.");
}

pubVoteBtn.onclick = sendPublicVote;

/* ======================
   MODE SWITCH
====================== */
function showPublicMode(){
  appMain.classList.add("hide");
  appPublic.classList.remove("hide");
}
function showMainMode(){
  appPublic.classList.add("hide");
  appMain.classList.remove("hide");
}

/* ======================
   INIT
====================== */
buildCriteria();
refreshMode();
listenState();
listenMeta();

// keep roster session aligned
rosterSession.value = sessione.value;

// on changes
ruolo.onchange = () => {
  submittedBadge.classList.add("hide");
  sync.textContent = "‚Äî";
  clearVideo();
  refreshMode();
  if (isJudge()) listenPerformanceForJudges();
};

sessione.onchange = () => {
  rosterSession.value = sessione.value;
  listenState();
  if (isJudge()) listenPerformanceForJudges();
  if (isAdmin() && isAdminUnlocked()) refreshAdminRosterPreview();
};

// network badge
window.addEventListener("online",  ()=> envBadge.textContent = "Online");
window.addEventListener("offline", ()=> envBadge.textContent = "Offline");

/* ======================
   FORCE ROLE FROM URL
====================== */
let forcedRole = null;
let forcedSessionFromUrl = null;

forcedRole = getUrlRole();
if (forcedRole){
  ruolo.value = forcedRole;
  ruolo.disabled = true;
  roleLockHint.textContent = "Ruolo bloccato dal link";
  lockRoleAndSessionForNonAdmin();
  refreshMode();              // üëà AGGIUNTA
  if (isJudge()) listenPerformanceForJudges();
  if (isPublic()) showPublicMode();
}

/* ======================
   APPLY INITIAL RECALC
====================== */
recalc();
</script>
</body>
</html>
